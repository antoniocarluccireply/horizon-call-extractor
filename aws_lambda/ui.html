<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Horizon & EDF Call Extractor</title>
  <style>
    :root{
      --bg:#f9f2ec;
      --card:rgba(255,255,255,0.96);
      --stroke:rgba(255,255,255,0.7);
      --text:#1f0f0f;
      --muted:#5d2e2e;
      --muted2:#7a4a4a;
      --accent:#d9a441;
      --accent-strong:#b97a24;
      --good:#2f855a;
      --warn:#d97706;
      --bad:#b23b3b;
      --shadow: 0 16px 40px rgba(0,0,0,.22);
      --radius: 16px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color: var(--text);
      background:
        radial-gradient(1100px 820px at 16% 12%, rgba(255, 228, 228, 0.16), transparent 55%),
        radial-gradient(900px 620px at 82% 18%, rgba(255, 190, 190, 0.16), transparent 55%),
        radial-gradient(1600px 980px at 50% -8%, rgba(255, 225, 225, 0.12), transparent 60%),
        linear-gradient(180deg, #b01231, #8c0d27 52%, #5c0818);
    }
    .wrap{
      max-width: 1100px;
      margin: 32px auto 80px;
      padding: 0 20px;
    }
    .topbar{
      display:flex;
      align-items:center;
      gap:14px;
      background: rgba(255,255,255,0.94);
      border-radius: calc(var(--radius) + 4px);
      padding: 14px 16px;
      border: 1px solid var(--stroke);
      box-shadow: 0 12px 30px rgba(0,0,0,.18);
    }
    .logo{
      width: 104px;
      height:auto;
      border-radius: 12px;
      background:#fff;
      padding: 10px;
      box-shadow: 0 10px 26px rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.8);
      flex-shrink:0;
    }
    .brand h1{ margin:0; font-size: 18px; }
    .brand p{ margin:4px 0 0; color: var(--muted); font-size: 13px; line-height:1.5; }
    .card{
      margin-top: 18px;
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px;
    }
    .tabs{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .tab{
      border:1px solid #dbcfc4;
      background:#f5f0e8;
      color: var(--text);
      padding: 8px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:700;
    }
    .tab.active{
      border-color: var(--accent);
      color: #2f241c;
      box-shadow: 0 6px 16px rgba(79,113,80,.22);
    }
    .filters{
      margin: 14px 0 12px;
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 12px;
    }
    .filterlabel{
      color: var(--muted);
      font-size: 12px;
      font-weight: 700;
      letter-spacing:.3px;
      text-transform: uppercase;
      margin-bottom: 6px;
    }
    .textinput, select{
      width: 100%;
      border: 1px solid #d9d1c4;
      border-radius: var(--radius);
      padding: 10px 12px;
      font-size: 14px;
      background: #fffdfa;
      color: var(--text);
    }
    .textinput:disabled{ background: #f4f0e8; color: var(--muted); }
    .sliderwrap{
      background:#f9f6f1;
      border:1px solid #e6ded3;
      border-radius: 14px;
      padding: 12px;
    }
    .dropdown{
      display:none;
      border:1px solid #d9d1c4;
      border-radius: 14px;
      padding: 10px;
      background:#ffffff;
      box-shadow: 0 14px 28px rgba(28,25,20,.12);
    }
    .textinput.clickable{ cursor:pointer; }
    .bubble{
      display:inline-block;
      padding: 6px 10px;
      border-radius: 10px;
      background: #2f855a;
      color:#fff;
      font-weight: 700;
      font-size: 13px;
      margin-bottom: 8px;
      box-shadow: 0 10px 22px rgba(47,133,90,.24);
    }
    .dropzone{
      position: relative;
      border-radius: 16px;
      border: 1px dashed rgba(107,139,95,.45);
      background: #f9f6f1;
      padding: 18px;
      transition: .15s ease;
    }
    .dropzone.drag{
      border-color: var(--accent);
      box-shadow: 0 0 0 4px rgba(107,139,95,.12);
      transform: translateY(-1px);
      background: #f4f0e8;
    }
    .dzrow{ display:flex; gap: 12px; align-items:flex-start; flex-wrap: wrap; }
    .filemeta{ flex:1 1 auto; min-width: 220px; }
    .filename{
      font-weight: 650;
      font-size: 14px;
      overflow-wrap:anywhere;
      word-break: break-word;
    }
    .filelist{ margin:6px 0 0; padding-left: 16px; color: var(--muted2); font-size: 12px; line-height:1.35; }
    .filesub{ color: var(--muted2); font-size: 12px; }
    .actions{ display:flex; gap: 10px; flex-wrap: wrap; }
    .btn{
      appearance:none;
      border:1px solid var(--stroke);
      background: #f0ede6;
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight: 650;
      font-size: 13px;
      display:inline-flex;
      align-items:center;
      gap: 8px;
    }
    .btn.primary{
      border: none;
      background: linear-gradient(90deg, var(--accent), var(--accent-strong));
      color: #ffffff;
      box-shadow: 0 8px 22px rgba(79,113,80,.28);
    }
    .btn.success{ background: linear-gradient(90deg, var(--good), #2a6f4c); color:#fff; }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }
    input[type=file]{ position:absolute; inset:0; opacity:0; pointer-events:none; }
    .progress{ margin-top: 12px; height: 10px; border-radius: 999px; background: #e6dfd3; border:1px solid #d9d2c7; overflow:hidden; }
    .bar{ width:0%; height:100%; border-radius:999px; background: linear-gradient(90deg, #88a17f, var(--accent)); transition: width .2s ease; }
    .bar.indet{ width:100%; animation: indet 1.2s infinite linear; transform-origin:left; }
    @keyframes indet{ 0%{ transform: translateX(-100%);} 100%{ transform: translateX(100%);} }
    .stepper{ margin-top: 14px; display:grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap: 10px; }
    .step{ border: 1px solid #d7d1c7; background: #faf7f2; border-radius: 12px; padding: 10px 12px; color: var(--muted2); font-size: 12px; display:flex; align-items:center; gap: 10px; min-height: 44px; }
    .badge{ width: 22px;height:22px;border-radius: 8px; display:flex;align-items:center;justify-content:center; border: 1px solid #d7d1c7; background: #ede6db; color: var(--muted); font-weight: 750; font-size: 12px; flex: 0 0 auto; }
    .step.active{ color: var(--text); border-color: rgba(107,139,95,.6); background: rgba(107,139,95,.12); }
    .step.done{ color: #244c38; border-color: rgba(47,133,90,.35); background: rgba(47,133,90,.12); }
    .statusbox{ margin-top: 14px; border-radius: 14px; padding: 12px; border: 1px solid #dcd4c9; background: #f9f7f2; }
    .statusline{ display:flex; align-items:flex-start; gap: 10px; font-size: 13px; color: var(--muted); white-space: pre-wrap; line-height: 1.45; }
    .kpi{ margin-top: 10px; display:flex; gap: 10px; flex-wrap: wrap; align-items:center; }
    .chip{ border: 1px solid #d7d1c7; background: #f1ece4; border-radius: 999px; padding: 7px 10px; font-size: 12px; color: var(--muted); display:inline-flex; align-items:center; gap: 8px; }
    .results{ display:none; }
    .results.active{ display:block; }
    .table{ margin-top: 10px; display: grid; gap: 10px; }
    .row-card{ border:1px solid #e0d7c9; background:#f9f6f1; border-radius: 14px; padding: 12px; display:grid; gap: 8px; overflow-wrap:anywhere; }
    .row-grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 8px 12px; }
    .cell{ display:flex; flex-direction:column; gap:4px; }
    .label{ color: var(--muted2); font-size: 11px; letter-spacing:.2px; text-transform: uppercase; }
    .idline{ display:flex; gap: 8px; align-items:center; flex-wrap: wrap; overflow-wrap:anywhere; }
    .pill{ background:#e8ddc9; border-radius: 10px; padding: 4px 8px; font-size: 12px; color: #3a281d; }
    a.link{ color: var(--accent-strong); text-decoration:none; border-bottom: 1px dashed rgba(79,113,80,.55); }
    .subtitle{ color: var(--text); font-weight:600; line-height:1.45; }
    .small{ color: var(--muted2); font-size: 12px; }
    .hint{ color: var(--muted2); font-size: 12px; margin-top: 4px; }
    @media (max-width: 760px){
      .wrap{ padding: 0 16px; }
      .filters{ grid-template-columns: 1fr; }
      .stepper{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 520px){
      .stepper{ display:flex; flex-direction: column; }
      .dropzone{ padding: 14px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <img class="logo" alt="Adeptic" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNDAiIGhlaWdodD0iMjQwIiB2aWV3Qm94PSIwIDAgMjQwIDI0MCI+CiAgPGRlZnM+CiAgICA8bGluZWFyR3JhZGllbnQgaWQ9ImJnIiB4MT0iMCIgeDI9IjEiIHkxPSIwIiB5Mj0iMSI+CiAgICAgIDxzdG9wIG9mZnNldD0iMCUiIHN0b3AtY29sb3I9IiNmN2VmZTQiLz4KICAgICAgPHN0b3Agb2Zmc2V0PSIxMDAlIiBzdG9wLWNvbG9yPSIjZTZkNmJlIi8+CiAgICA8L2xpbmVhckdyYWRpZW50PgogIDwvZGVmcz4KICA8cmVjdCB3aWR0aD0iMjQwIiBoZWlnaHQ9IjI0MCIgcng9IjMyIiBmaWxsPSJ1cmwoI2JnKSIgc3Ryb2tlPSIjZDljNmE5IiBzdHJva2Utd2lkdGg9IjQiLz4KICA8Y2lyY2xlIGN4PSI1NiIgY3k9IjE4NCIgcj0iMjIiIGZpbGw9IiNkOWE0NDEiIG9wYWNpdHk9IjAuOSIvPgogIDx0ZXh0IHg9IjEyMCIgeT0iMTI4IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LWZhbWlseT0iJ0ludGVyJywnU2Vnb2UgVUknLEFyaWFsLHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iNDgiIGZvbnQtd2VpZ2h0PSI3MDAiIGZpbGw9IiMxZjBmMGYiPkFkZXB0aWM8L3RleHQ+CiAgPHRleHQgeD0iMTIwIiB5PSIxNjgiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtZmFtaWx5PSdJbnRlcicsJ1NlZ29lIFVJJyxBcmlhbCxzYW5zLXNlcmlmIiBmb250LXNpemU9IjE4IiBmaWxsPSIjNWQyZTJlIiBvcGFjaXR5PSIwLjc1Ij5DYWxsIEV4dHJhY3RvcjwvdGV4dD4KPC9zdmc+" />
      <div class="brand">
        <h1>Horizon & EDF Call Extractor</h1>
        <p>Upload Horizon or EDF PDFs → automatic detection → tables + Excel on click. Mobile-friendly, no auto-downloads.</p>
      </div>
    </div>

    <div class="card">
      <div class="tabs">
        <button class="tab active" data-tab="horizon" id="tab-horizon">Horizon</button>
        <button class="tab" data-tab="edf" id="tab-edf">EDF</button>
      </div>
      <p class="hint">The backend checks PDF text (“Horizon Europe”, “Work Programme”, “EDF-2026-…”) to prevent mismatches.</p>

      <div class="filters" data-panel="horizon">
        <div>
          <div class="filterlabel">Call types</div>
          <div class="textinput clickable" id="typeSummary">All types</div>
          <div class="hint">Tap below to edit</div>
          <div class="dropdown" id="typeMenu" style="margin-top:6px; display:none;">
            <div class="actions" style="margin-bottom:6px;">
              <button class="btn" type="button" id="typeAll">Select all</button>
              <button class="btn" type="button" id="typeNone">Select none</button>
            </div>
            <div id="typeList"></div>
          </div>
        </div>
        <div>
          <div class="filterlabel">Min. budget per project (M€)</div>
          <div class="sliderwrap">
            <div class="bubble" id="budgetBubble">0 M€</div>
            <input type="range" id="budget" min="0" max="15" step="1" value="0" aria-label="Minimum budget per project in million euros"/>
            <div class="hint">Supports 15+ when moved to the end.</div>
          </div>
        </div>
        <div>
          <div class="filterlabel">Opening date</div>
          <input class="textinput" id="openFilter" type="text" placeholder="2026 or 2026-Q1 or 2026-05"/>
        </div>
        <div>
          <div class="filterlabel">Deadline date</div>
          <input class="textinput" id="deadlineFilter" type="text" placeholder="2027 or 2027-11-15"/>
        </div>
      </div>

      <div class="filters" data-panel="edf" style="display:none;">
        <div>
          <div class="filterlabel">Call family</div>
          <select id="edfFamily">
            <option value="">Any</option>
            <option value="RA">RA — Research Actions</option>
            <option value="DA">DA — Development Actions</option>
            <option value="LS">LS — Large-scale projects</option>
          </select>
          <div class="hint">Matches the call prefix (e.g., EDF-2024-RA-…)</div>
        </div>
        <div>
          <div class="filterlabel">Indicative budget min (M€)</div>
          <input class="textinput" id="edfBudgetMin" type="number" min="0" step="0.1" placeholder="e.g. 5" />
        </div>
        <div>
          <div class="filterlabel">Indicative budget max (M€)</div>
          <input class="textinput" id="edfBudgetMax" type="number" min="0" step="0.1" placeholder="e.g. 20" />
        </div>
        <div>
          <div class="filterlabel">STEP</div>
          <select id="edfStep">
            <option value="">Any</option>
            <option value="yes">Yes</option>
            <option value="no">No</option>
          </select>
        </div>
      </div>

      <div class="dropzone" id="dz">
        <input id="fileInput" type="file" accept="application/pdf" multiple />
        <div class="dzrow">
          <div class="filemeta">
            <div class="filename" id="filename">No files selected</div>
            <div class="filesub" id="filesub">Horizon: upload 1–6 PDFs. EDF: single PDF.</div>
            <ul class="filelist" id="filelist"></ul>
          </div>
          <div class="actions">
            <button class="btn" id="clear" disabled>Remove</button>
            <button class="btn primary" id="go" disabled>Generate Excel</button>
          </div>
        </div>
        <div class="progress" aria-label="progress">
          <div class="bar" id="bar"></div>
        </div>
        <div class="stepper" aria-label="steps">
          <div class="step" id="s1"><span class="badge">1</span><span>Presign URL</span></div>
          <div class="step" id="s2"><span class="badge">2</span><span>Upload PDFs</span></div>
          <div class="step" id="s3"><span class="badge">3</span><span>Parse + Excel</span></div>
          <div class="step" id="s4"><span class="badge">4</span><span>Download link</span></div>
        </div>
        <div class="statusbox">
          <div class="statusline" id="status">
            <div>
              <div class="ok" id="statusMain">Select PDF(s) to get started.</div>
              <div class="hint" id="statusSub">Drag & drop or tap to choose. No auto-downloads on mobile.</div>
            </div>
          </div>
          <div class="kpi" id="kpi" style="display:none;">
            <div class="chip">Rows: <strong id="rows">0</strong></div>
            <div class="chip">Status: <strong id="final">Ready</strong></div>
            <button class="btn primary" id="downloadBtn" style="display:none;">Download Excel</button>
          </div>
        </div>
      </div>
    </div>

    <div class="card results active" id="results-horizon">
      <h3>Horizon table</h3>
      <p class="hint">Mobile-friendly cards, Topic ID links to the Funding &amp; Tenders portal. Action type shown next to the topic ID.</p>
      <div class="table" id="table-horizon"></div>
    </div>

    <div class="card results" id="results-edf">
      <h3>EDF table</h3>
      <p class="hint">Topic IDs stay as text (no links). Fields: call, topic, action, indicative budget, number of actions, STEP.</p>
      <div class="table" id="table-edf"></div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const ACTION_TYPES = ["RIA","IA","CSA","PCP","PPI","COFUND","ERC","MSCA","EIC-PATHFINDER","EIC-TRANSITION","EIC-ACCELERATOR"];
    const state = {
      activeTab: "horizon",
      tabs: {
        horizon: { files: [], selectedTypes: new Set(ACTION_TYPES), minBudget: 0, openingFilter: "", deadlineFilter: "" },
        edf: { files: [], callFamily: "", budgetMin: "", budgetMax: "", step: "" },
      },
      results: {
        horizon: { rows: [], downloadUrl: null, rowsCount: 0 },
        edf: { rows: [], downloadUrl: null, rowsCount: 0 },
      },
      busy: false,
    };

    function fmtBytes(bytes){
      const u = ["B","KB","MB","GB"];
      let i = 0; let n = bytes;
      while(n >= 1024 && i < u.length-1){ n/=1024; i++; }
      return (i === 0 ? n : n.toFixed(1)) + " " + u[i];
    }

    const budgetFormatter = new Intl.NumberFormat("en-US", { minimumFractionDigits: 0, maximumFractionDigits: 2 });
    function formatBudget(val){
      const num = Number(val);
      if(Number.isNaN(num)) return "—";
      const digits = Number.isInteger(num) ? 0 : (Math.abs(num) < 10 ? 2 : 1);
      const formatted = num.toLocaleString("en-US", { minimumFractionDigits: 0, maximumFractionDigits: digits });
      return `${formatted} M€`;
    }

    function updateTypeSummary(){
      const sel = state.tabs.horizon.selectedTypes;
      const size = sel.size;
      let summary = "All types";
      if(size === ACTION_TYPES.length){ summary = "All types"; }
      else if(size === 1){ summary = Array.from(sel)[0]; }
      else if(size > 1){ summary = `${Array.from(sel)[0]} +${size-1}`; }
      $("typeSummary").textContent = summary;
    }

    function renderTypeList(){
      const box = $("typeList");
      box.innerHTML = "";
      ACTION_TYPES.forEach(t => {
        const lbl = document.createElement("label");
        lbl.style.display = "inline-flex";
        lbl.style.alignItems = "center";
        lbl.style.gap = "8px";
        lbl.style.marginRight = "10px";
        lbl.style.marginBottom = "6px";
        const input = document.createElement("input");
        input.type = "checkbox"; input.value = t; input.checked = state.tabs.horizon.selectedTypes.has(t);
        input.onchange = () => {
          if(input.checked) state.tabs.horizon.selectedTypes.add(t); else state.tabs.horizon.selectedTypes.delete(t);
          updateTypeSummary();
        };
        const span = document.createElement("span"); span.textContent = t;
        lbl.appendChild(input); lbl.appendChild(span); box.appendChild(lbl);
      });
      updateTypeSummary();
    }

    function setBudget(val){
      const num = Math.min(15, Math.max(0, Math.round(Number(val) || 0)));
      state.tabs.horizon.minBudget = num;
      $("budget").value = String(num);
      $("budgetBubble").textContent = formatBudget(num);
    }

    function setStatus(main, sub, isError=false){
      $("statusMain").textContent = main;
      $("statusSub").textContent = sub || "";
      $("final").textContent = isError ? "ERROR" : "Ready";
      $("final").style.color = isError ? "var(--bad)" : "var(--text)";
    }

    function barNone(){ $("bar").classList.remove("indet"); $("bar").style.width = "0%"; }
    function barIndeterminate(){ $("bar").classList.add("indet"); }
    function barSet(pct){ $("bar").classList.remove("indet"); $("bar").style.width = pct + "%"; }

    function setSteps(activeIdx, doneBefore=false){
      const steps = [$("s1"),$("s2"),$("s3"),$("s4")];
      steps.forEach((el, idx) => {
        el.classList.remove("active","done");
        if(doneBefore && idx < activeIdx) el.classList.add("done");
        if(idx === activeIdx) el.classList.add("active");
      });
    }
    function clearSteps(){ [$("s1"),$("s2"),$("s3"),$("s4")].forEach(el => el.classList.remove("active","done")); }

    function setBusy(busy){
      state.busy = busy;
      $("go").disabled = busy || !(state.tabs[state.activeTab].files.length);
      $("clear").disabled = busy || !(state.tabs[state.activeTab].files.length);
      $("fileInput").disabled = busy;
      $("budget").disabled = busy;
      $("openFilter").disabled = busy;
      $("deadlineFilter").disabled = busy;
      $("edfFamily").disabled = busy;
      $("edfBudgetMin").disabled = busy;
      $("edfBudgetMax").disabled = busy;
      $("edfStep").disabled = busy;
    }

    function setFiles(tab, files){
      state.tabs[tab].files = files || [];
      state.results[tab] = { rows: [], downloadUrl: null, rowsCount: 0 };
      $("downloadBtn").style.display = "none";
      $("kpi").style.display = "none";
      renderFileList();
      setBusy(false);
      if(files.length){
        setStatus("Ready to generate Excel.", `${files.length} PDF${files.length>1?"s":""} selected.`);
      } else {
        setStatus("Select PDF(s) to get started.", "Drag & drop or tap to choose.");
        clearSteps(); barNone();
      }
    }

    function renderFileList(){
      const files = state.tabs[state.activeTab].files;
      if(!files.length){
        $("filename").textContent = "No files selected";
        $("filesub").textContent = "Horizon: upload 1–6 PDFs. EDF: single PDF.";
        $("filelist").innerHTML = "";
        return;
      }
      $("filename").textContent = files.length === 1 ? (files[0].name || "file.pdf") : `${files.length} PDFs selected`;
      $("filesub").textContent = files.length === 1 ? `${fmtBytes(files[0].size)} • ${(files[0].type || "application/pdf")}` : "Multi-upload enabled (Horizon only).";
      $("filelist").innerHTML = files.map(f => `<li>${f.name || "file.pdf"}</li>`).join("");
    }

    function switchTab(tab){
      if(state.activeTab === tab) return;
      state.activeTab = tab;
      document.querySelectorAll(".tab").forEach(btn => btn.classList.toggle("active", btn.dataset.tab === tab));
      document.querySelector('[data-panel=\"horizon\"]').style.display = tab === "horizon" ? "grid" : "none";
      document.querySelector('[data-panel=\"edf\"]').style.display = tab === "edf" ? "grid" : "none";
      $("results-horizon").classList.toggle("active", tab === "horizon");
      $("results-edf").classList.toggle("active", tab === "edf");
      $("fileInput").multiple = tab === "horizon";
      setFiles(tab, state.tabs[tab].files);
      renderResults(tab);
    }

    function isPdfFile(f){
      const nameOk = (f.name || "").toLowerCase().endsWith(".pdf");
      const typeOk = (f.type || "") === "application/pdf";
      return nameOk || typeOk;
    }

    const dz = $("dz");
    dz.addEventListener("click", (e) => {
      if(e.target.closest("button")) return;
      $("fileInput").click();
    });
    ["dragenter","dragover"].forEach(evt => dz.addEventListener(evt, (e) => {
      e.preventDefault(); e.stopPropagation(); dz.classList.add("drag");
    }));
    ["dragleave","drop"].forEach(evt => dz.addEventListener(evt, (e) => {
      e.preventDefault(); e.stopPropagation(); dz.classList.remove("drag");
    }));
    dz.addEventListener("drop", (e) => {
      const files = Array.from(e.dataTransfer?.files || []).filter(isPdfFile);
      if(!files.length){
        setStatus("Invalid format.", "Select PDF files (.pdf).", true);
        return;
      }
      applyFileSelection(files);
    });

    function applyFileSelection(files){
      const tab = state.activeTab;
      if(tab === "horizon" && files.length > 6){
        setStatus("Too many files.", "Upload up to 6 Horizon PDFs at once.", true);
        return;
      }
      if(tab === "edf" && files.length !== 1){
        setStatus("EDF accepts one PDF per run.", "Please select a single EDF PDF.", true);
        return;
      }
      if(!files.every(isPdfFile)){
        setStatus("Invalid format.", "Select PDF files (.pdf).", true);
        return;
      }
      setFiles(tab, files);
    }

    $("fileInput").addEventListener("change", () => {
      const files = Array.from($("fileInput").files || []);
      if(!files.length) return;
      applyFileSelection(files);
      $("fileInput").value = "";
    });

    $("clear").onclick = () => { setFiles(state.activeTab, []); $("fileInput").value = ""; };

    $("typeSummary").onclick = () => { $("typeMenu").style.display = $("typeMenu").style.display === "block" ? "none" : "block"; };
    $("typeAll").onclick = () => { state.tabs.horizon.selectedTypes = new Set(ACTION_TYPES); updateTypeSummary(); };
    $("typeNone").onclick = () => { state.tabs.horizon.selectedTypes = new Set(); updateTypeSummary(); };
    document.addEventListener("click", (e) => {
      if(e.target === $("typeSummary") || $("typeMenu").contains(e.target)) return;
      $("typeMenu").style.display = "none";
    });

    $("budget").addEventListener("input", (e) => setBudget(e.target.value));
    $("openFilter").addEventListener("input", (e) => state.tabs.horizon.openingFilter = (e.target.value || "").trim());
    $("deadlineFilter").addEventListener("input", (e) => state.tabs.horizon.deadlineFilter = (e.target.value || "").trim());
    $("edfFamily").addEventListener("change", (e) => state.tabs.edf.callFamily = (e.target.value || "").trim());
    $("edfBudgetMin").addEventListener("input", (e) => state.tabs.edf.budgetMin = e.target.value);
    $("edfBudgetMax").addEventListener("input", (e) => state.tabs.edf.budgetMax = e.target.value);
    $("edfStep").addEventListener("change", (e) => state.tabs.edf.step = e.target.value);

    $("tab-horizon").onclick = () => switchTab("horizon");
    $("tab-edf").onclick = () => switchTab("edf");

    $("downloadBtn").onclick = () => {
      const dl = state.results[state.activeTab].downloadUrl;
      if(dl) window.location = dl;
    };

    function formatStepValue(v){
      if(v === true) return "Yes";
      if(v === false) return "No";
      return "—";
    }

    function renderResults(tab){
      const res = state.results[tab];
      $("rows").textContent = String(res.rowsCount || res.rows.length || 0);
      $("kpi").style.display = res.rows.length ? "flex" : "none";
      const dlBtn = $("downloadBtn");
      dlBtn.style.display = res.downloadUrl ? "inline-flex" : "none";
      dlBtn.classList.toggle("success", Boolean(res.downloadUrl));

      if(tab === "horizon"){
        const box = $("table-horizon");
        box.innerHTML = "";
        res.rows.forEach((r) => {
          const card = document.createElement("div");
          card.className = "row-card";
          const id = document.createElement("div");
          id.className = "idline";
          if(r.topic_url){
            const a = document.createElement("a");
            a.href = r.topic_url;
            a.target = "_blank"; a.rel = "noreferrer";
            a.textContent = r.topic_id || "—";
            a.className = "link";
            id.appendChild(a);
          } else {
            const span = document.createElement("span");
            span.textContent = r.topic_id || "—";
            id.appendChild(span);
          }
          const pill = document.createElement("span");
          pill.className = "pill"; pill.textContent = r.action_type || "—";
          id.appendChild(pill);
          card.appendChild(id);
          const title = document.createElement("div");
          title.className = "subtitle"; title.textContent = r.topic_title || "—";
          card.appendChild(title);

          const grid = document.createElement("div");
          grid.className = "row-grid";
          const fields = [
            ["Call ID", r.call_id || "—"],
            ["TRL", r.trl || "—"],
            ["Budget (M€)", formatBudget(r.budget_per_project_min_eur_m)],
            ["Opening date", r.opening_date || "—"],
            ["Deadline date", r.deadline_date || "—"],
            ["Page", r.page || "—"],
          ];
          fields.forEach(([label, value]) => {
            const c = document.createElement("div");
            c.className = "cell";
            const l = document.createElement("span"); l.className = "label"; l.textContent = label;
            const v = document.createElement("span"); v.textContent = value ?? "—";
            c.appendChild(l); c.appendChild(v); grid.appendChild(c);
          });
          card.appendChild(grid);
          box.appendChild(card);
        });
      } else {
        const box = $("table-edf");
        box.innerHTML = "";
        res.rows.forEach((r) => {
          const card = document.createElement("div");
          card.className = "row-card";
          const id = document.createElement("div");
          id.className = "idline";
          const tid = document.createElement("span"); tid.textContent = r.topic_id || "—";
          id.appendChild(tid);
          card.appendChild(id);
          const title = document.createElement("div"); title.className = "subtitle"; title.textContent = r.topic_title || "—";
          card.appendChild(title);

          const grid = document.createElement("div"); grid.className = "row-grid";
          const fields = [
            ["Call ID", r.call_id || "—"],
            ["Call family", r.call_family || "—"],
            ["Type of action", r.type_of_action || "—"],
            ["Indicative budget (M€)", formatBudget(r.indicative_budget_eur_m)],
            ["Number of actions", r.number_of_actions ?? "—"],
            ["STEP", formatStepValue(r.step)],
          ];
          fields.forEach(([label, value]) => {
            const c = document.createElement("div"); c.className = "cell";
            const l = document.createElement("span"); l.className = "label"; l.textContent = label;
            const v = document.createElement("span"); v.textContent = value ?? "—";
            c.appendChild(l); c.appendChild(v); grid.appendChild(c);
          });
          card.appendChild(grid);
          box.appendChild(card);
        });
      }
    }

    function resetResult(tab){
      state.results[tab] = { rows: [], downloadUrl: null, rowsCount: 0 };
      $("downloadBtn").style.display = "none";
      $("downloadBtn").classList.remove("success");
      $("kpi").style.display = "none";
      renderResults(tab);
    }

    async function fetchJson(url, opts){
      const res = await fetch(url, opts);
      const text = await res.text();
      let data = null;
      try{ data = text ? JSON.parse(text) : null; }catch(e){}
      if(!res.ok){
        const msg = (data && (data.message || data.error)) ? (data.message || data.error) : (text || ("HTTP " + res.status));
        const err = new Error(msg); err.status = res.status; err.payload = data; throw err;
      }
      return data;
    }

    $("go").onclick = async () => {
      const tab = state.activeTab;
      const files = state.tabs[tab].files;
      if(!files.length){
        setStatus("Select PDF(s).", tab === "horizon" ? "Upload 1–6 Horizon PDFs." : "Upload one EDF PDF.", true);
        return;
      }
      setBusy(true); resetResult(tab); barIndeterminate();
      try{
        // Presign
        setSteps(0, false);
        setStatus("1/4 • Presign URL", "Requesting S3 upload links.");
        const pres = await fetchJson(`/presign?count=${files.length}`);
        const uploads = pres.uploads || (pres.upload_url ? [{ upload_url: pres.upload_url, pdf_key: pres.pdf_key }] : []);
        if(uploads.length !== files.length){
          throw new Error("Presign count mismatch.");
        }

        // Upload
        setSteps(1, true);
        for(let i=0; i<uploads.length; i++){
          setStatus(`2/4 • Uploading ${i+1}/${uploads.length}`, files[i].name || "");
          const put = await fetch(uploads[i].upload_url, { method:"PUT", body: files[i] });
          if(!put.ok) throw new Error("Upload failed: HTTP " + put.status);
        }

        // Process
        setSteps(2, true);
        setStatus("3/4 • Parsing + Excel…", "Detecting document family, applying filters, building workbook.");
        const payload = {
          pdf_keys: uploads.map(u => u.pdf_key),
          expected_type: tab,
          original_names: files.map(f => f.name || ""),
        };
        if(tab === "horizon"){
          payload.action_types = Array.from(state.tabs.horizon.selectedTypes);
          payload.min_budget_m = state.tabs.horizon.minBudget;
          payload.opening_filter = state.tabs.horizon.openingFilter;
          payload.deadline_filter = state.tabs.horizon.deadlineFilter;
        } else {
          payload.edf_filters = {
            call_family: state.tabs.edf.callFamily,
            budget_min_m: state.tabs.edf.budgetMin,
            budget_max_m: state.tabs.edf.budgetMax,
            step: state.tabs.edf.step,
          };
        }

        const proc = await fetchJson("/process", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        // Download link
        setSteps(3, true);
        setStatus("4/4 • Preparing download…", "Creating a temporary Excel link.");
        const dl = await fetchJson("/download", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ excel_key: proc.excel_key }),
        });

        state.results[tab] = { rows: proc.rows || [], downloadUrl: dl.download_url, rowsCount: proc.rows_count || 0 };
        barSet(100);
        [$("s1"),$("s2"),$("s3"),$("s4")].forEach(el => { el.classList.remove("active"); el.classList.add("done"); });
        renderResults(tab);
        setStatus("Completed ✅", "Download available on button click. No auto-downloads.");
        const container = tab === "horizon" ? $("results-horizon") : $("results-edf");
        container.scrollIntoView({ behavior: "smooth", block: "start" });
      }catch(e){
        barNone(); clearSteps();
        const msg = e?.message || String(e);
        const detail = e?.status ? `HTTP ${e.status}. ` : "";
        setStatus("Error during processing.", detail + msg, true);
      }finally{
        setBusy(false);
      }
    };

    // init
    renderTypeList();
    setBudget(state.tabs.horizon.minBudget);
    renderResults("horizon");
  </script>
</body>
</html>
