<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Horizon & EDF Call Extractor</title>
  <style>
    :root{
      --bg:#fbe9e9;
      --card:rgba(255,255,255,0.96);
      --stroke:rgba(255,255,255,0.7);
      --text:#1f0f0f;
      --muted:#5d2e2e;
      --muted2:#7a4a4a;
      --accent:#d9a441;
      --accent-strong:#b97a24;
      --good:#2f855a;
      --warn:#d97706;
      --bad:#b23b3b;
      --shadow: 0 16px 40px rgba(0,0,0,.22);
      --radius: 16px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color: var(--text);
      background:
        radial-gradient(1100px 820px at 16% 12%, rgba(255, 200, 200, 0.22), transparent 55%),
        radial-gradient(900px 620px at 82% 18%, rgba(255, 170, 170, 0.2), transparent 55%),
        radial-gradient(1600px 980px at 50% -8%, rgba(255, 210, 210, 0.18), transparent 60%),
        linear-gradient(180deg, #b23b3b, #8e2c2c 52%, #681f1f);
    }
    .wrap{
      max-width: 1100px;
      margin: 32px auto 80px;
      padding: 0 20px;
    }
    .topbar{
      display:flex;
      align-items:flex-start;
      gap:14px;
      background: rgba(255,255,255,0.94);
      border-radius: calc(var(--radius) + 4px);
      padding: 14px 16px;
      border: 1px solid var(--stroke);
      box-shadow: 0 12px 30px rgba(0,0,0,.18);
    }
    .logo{
      width: 104px;
      height:auto;
      border-radius: 12px;
      background:#fff;
      padding: 10px;
      box-shadow: 0 10px 26px rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.8);
      flex-shrink:0;
    }
    .topbar-header{
      flex:1 1 auto;
      display:flex;
      gap: 12px;
      justify-content: space-between;
      align-items:flex-start;
      flex-wrap: wrap;
    }
    .brand h1{ margin:0; font-size: 18px; }
    .brand p{ margin:4px 0 0; color: var(--muted); font-size: 13px; line-height:1.5; }
    .version-tag{
      margin-left:auto;
      background:#f5f0e8;
      border:1px solid #e1d6c7;
      color:#2f241c;
      border-radius: 10px;
      padding: 6px 10px;
      font-size: 12px;
      font-weight: 700;
      white-space: nowrap;
      align-self:flex-start;
      flex-shrink:0;
    }
    .card{
      margin-top: 18px;
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px;
    }
    .tabs{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .tab{
      border:1px solid #dbcfc4;
      background:#f5f0e8;
      color: var(--text);
      padding: 8px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:700;
    }
    .tab.active{
      border-color: var(--accent);
      color: #2f241c;
      box-shadow: 0 6px 16px rgba(79,113,80,.22);
    }
    .filters{
      margin: 14px 0 12px;
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    .filter-item{ display:flex; flex-direction:column; gap: 6px; }
    .date-row{ display:flex; gap: 8px; align-items:center; flex-wrap: wrap; }
    .clear-btn{
      padding: 8px 10px;
      font-size: 12px;
      border-radius: 10px;
      background: #f5f0e8;
      border-color: #d9d1c4;
    }
    .clear-btn:disabled{ opacity: .6; cursor:not-allowed; }
    .filterlabel{
      color: var(--muted);
      font-size: 12px;
      font-weight: 700;
      letter-spacing:.3px;
      text-transform: uppercase;
      margin-bottom: 6px;
    }
    .textinput, select{
      width: 100%;
      border: 1px solid #d9d1c4;
      border-radius: var(--radius);
      padding: 10px 12px;
      font-size: 14px;
      background: #fffdfa;
      color: var(--text);
    }
    .textinput:disabled{ background: #f4f0e8; color: var(--muted); }
    .sliderwrap{
      background:#f9f6f1;
      border:1px solid #e6ded3;
      border-radius: 14px;
      padding: 12px;
    }
    .dropdown{
      display:none;
      border:1px solid #d9d1c4;
      border-radius: 14px;
      padding: 10px;
      background:#ffffff;
      box-shadow: 0 14px 28px rgba(28,25,20,.12);
    }
    .textinput.clickable{ cursor:pointer; }
    .bubble{
      display:inline-block;
      padding: 6px 10px;
      border-radius: 10px;
      background: #2f855a;
      color:#fff;
      font-weight: 700;
      font-size: 13px;
      margin-bottom: 8px;
      box-shadow: 0 10px 22px rgba(47,133,90,.24);
    }
    .dropzone{
      position: relative;
      border-radius: 16px;
      border: 1px dashed rgba(107,139,95,.45);
      background: #f9f6f1;
      padding: 18px;
      transition: .15s ease;
    }
    .dropzone.drag{
      border-color: var(--accent);
      box-shadow: 0 0 0 4px rgba(107,139,95,.12);
      transform: translateY(-1px);
      background: #f4f0e8;
    }
    .dzrow{ display:flex; gap: 12px; align-items:flex-start; flex-wrap: wrap; }
    .filemeta{ flex:1 1 auto; min-width: 220px; }
    .filename{
      font-weight: 650;
      font-size: 14px;
      overflow-wrap:anywhere;
      word-break: break-word;
    }
    .filelist{ margin:6px 0 0; padding-left: 16px; color: var(--muted2); font-size: 12px; line-height:1.35; }
    .filesub{ color: var(--muted2); font-size: 12px; }
    .actions{ display:flex; gap: 10px; flex-wrap: wrap; }
    .btn{
      appearance:none;
      border:1px solid var(--stroke);
      background: #f0ede6;
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight: 650;
      font-size: 13px;
      display:inline-flex;
      align-items:center;
      gap: 8px;
    }
    .btn.primary{
      border: none;
      background: linear-gradient(90deg, var(--accent), var(--accent-strong));
      color: #ffffff;
      box-shadow: 0 8px 22px rgba(79,113,80,.28);
    }
    .btn.success{ background: linear-gradient(90deg, var(--good), #2a6f4c); color:#fff; }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }
    input[type=file]{ position:absolute; inset:0; opacity:0; pointer-events:none; }
    .progresswrap{ margin-top: 12px; display:flex; flex-direction:column; gap:6px; }
    .progressline{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap: wrap; color: var(--muted); font-size: 13px; font-weight:700; }
    .progressstage{ color:#2f241c; font-weight:800; }
    .progressvalue{ color: #1f2c1f; font-weight: 800; }
    .progress{ height: 12px; border-radius: 999px; background: #e6dfd3; border:1px solid #d9d2c7; overflow:hidden; }
    .bar{ width:0%; height:100%; border-radius:999px; background: linear-gradient(90deg, #88a17f, var(--accent)); transition: width .2s ease; }
    .bar.indet{ width:100%; animation: indet 1.2s infinite linear; transform-origin:left; }
    @keyframes indet{ 0%{ transform: translateX(-100%);} 100%{ transform: translateX(100%);} }
    @keyframes spin{ to{ transform: rotate(360deg); } }
    .stepper{ margin-top: 14px; display:grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap: 10px; }
    .step{ border: 1px solid #d7d1c7; background: #faf7f2; border-radius: 12px; padding: 10px 12px; color: var(--muted2); font-size: 12px; display:flex; align-items:center; gap: 10px; min-height: 44px; }
    .badge{ width: 22px;height:22px;border-radius: 8px; display:flex;align-items:center;justify-content:center; border: 1px solid #d7d1c7; background: #ede6db; color: var(--muted); font-weight: 750; font-size: 12px; flex: 0 0 auto; }
    .step.active{ color: var(--text); border-color: rgba(107,139,95,.6); background: rgba(107,139,95,.12); }
    .step.done{ color: #244c38; border-color: rgba(47,133,90,.35); background: rgba(47,133,90,.12); }
    .statusbox{ margin-top: 14px; border-radius: 14px; padding: 12px; border: 1px solid #dcd4c9; background: #f9f7f2; }
    .statusline{ display:flex; align-items:flex-start; gap: 10px; font-size: 13px; color: var(--muted); white-space: pre-wrap; line-height: 1.45; }
    .kpi{ margin-top: 10px; display:flex; gap: 10px; flex-wrap: wrap; align-items:center; }
    .chip{ border: 1px solid #d7d1c7; background: #f1ece4; border-radius: 999px; padding: 7px 10px; font-size: 12px; color: var(--muted); display:inline-flex; align-items:center; gap: 8px; }
    .results{ display:none; }
    .results.active{ display:block; }
    .table{ margin-top: 10px; display: grid; gap: 10px; }
    .row-card{ border:1px solid #e0d7c9; background:#f9f6f1; border-radius: 14px; padding: 12px; display:grid; gap: 8px; overflow-wrap:anywhere; width:100%; min-width:0; }
    .row-grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 8px 12px; }
    .cell{ display:flex; flex-direction:column; gap:4px; }
    .label{ color: var(--muted2); font-size: 11px; letter-spacing:.2px; text-transform: uppercase; }
    .idline{ display:flex; gap: 8px; align-items:center; flex-wrap: wrap; overflow-wrap:anywhere; }
    .pill{ background:#e8ddc9; border-radius: 10px; padding: 4px 8px; font-size: 12px; color: #3a281d; }
    .callline{ display:flex; align-items:center; gap: 8px; flex-wrap: wrap; }
    .callpill{ background:#d6c5a5; color:#2f241c; font-weight:700; }
    a.link{ color: var(--accent-strong); text-decoration:none; border-bottom: 1px dashed rgba(79,113,80,.55); }
    .subtitle{ color: var(--text); font-weight:600; line-height:1.45; width:100%; min-width:0; white-space: normal; overflow-wrap: break-word; word-break: break-word; }
    .small{ color: var(--muted2); font-size: 12px; }
    .hint{ color: var(--muted2); font-size: 12px; margin-top: 4px; }
    .accordion{ border:1px solid #decfbd; border-radius: 12px; background:#fdfbf7; }
    .accordion summary{ cursor:pointer; font-weight:700; padding: 8px 12px; list-style:none; color: #2f241c; }
    .accordion summary::-webkit-details-marker{ display:none; }
    .accordion[open] summary{ border-bottom:1px solid #e6dbcd; background:#f7f1e6; border-radius:12px 12px 0 0; }
    .accordion-body{ padding: 10px 12px 12px; }
    .rawtext{ white-space: pre-wrap; font-family: "SFMono-Regular",Consolas,"Liberation Mono",Menlo,monospace; font-size: 13px; color:#2f241c; }
    .desc-summary{ display:flex; gap: 8px; flex-wrap: wrap; align-items:center; }
    .desc-preview{ color: var(--muted2); font-size: 12px; font-weight: 500; }
    .desc-body{ line-height:1.4; font-size: 13px; color:#2f241c; width:100%; min-width:0; word-break: break-word; overflow-wrap:anywhere; }
    .summary-block{ display:flex; flex-direction:column; gap:4px; width:100%; min-width:0; }
    .summary-text{ color: var(--muted2); font-size: 13px; line-height:1.3; width:100%; min-width:0; word-break: break-word; overflow-wrap:anywhere; }
    .summary-text.expanded{ -webkit-line-clamp: unset; max-height:none; }
    .summary-text.desc-preview{ display:block; -webkit-line-clamp: unset; max-height:none; }
    .desc-content{ display:flex; flex-direction:column; width:100%; min-width:0; }
    .desc-content h4{ margin: 12px 0 6px; font-size: 12px; font-weight: 700; color: #2f241c; }
    .desc-content h4:first-child{ margin-top: 4px; }
    .desc-content p{ margin: 0 0 8px; font-size: 13px; line-height: 1.4; }
    .desc-content ul{ margin: 6px 0 10px; padding-left: 20px; list-style: disc; list-style-position: outside; }
    .desc-content p + ul{ margin-top: 4px; }
    .desc-content li{ line-height: 1.4; font-size: 13px; padding-left: 4px; }
    .desc-content li + li{ margin-top: 4px; }
    .desc-content .desc-separator{ margin: 8px 0; border-top: 1px solid #e0d7c9; }
    .desc-link{ color: #475569; text-decoration: none; word-break: break-all; }
    .desc-link:hover{ color: #334155; text-decoration: underline; text-underline-offset: 2px; }
    .desc-references{ margin-top: 16px; }
    .desc-references-title{ font-size: 12px; font-weight: 600; color: #64748b; margin: 0 0 4px; }
    .desc-references-list{ list-style: none; padding-left: 0; margin: 0; display: grid; gap: 4px; }
    .desc-reference-item{ font-size: 12px; line-height: 1.25; color: #64748b; display: flex; gap: 6px; align-items: flex-start; }
    .desc-reference-num{ color: #64748b; }
    .desc-reference-content{ display: flex; flex-wrap: wrap; gap: 4px; }
    .desc-footnote{ margin-left: 2px; font-size: 11px; color: #64748b; }
    .desc-footnote a{ color: inherit; text-decoration: none; }
    .desc-footnote a:hover{ text-decoration: underline; text-underline-offset: 2px; color: #475569; }
    .summary-toggle{ background:none; border:none; color: var(--accent-strong); font-weight:700; font-size:12px; cursor:pointer; padding:0; align-self:flex-start; }
    .modal-overlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      z-index: 9999;
    }
    .modal-card{
      width: 92%;
      max-width: 520px;
      background: #fffdfa;
      border: 1px solid #ede3d7;
      border-radius: 18px;
      box-shadow: 0 18px 44px rgba(0,0,0,.28);
      padding: 18px 18px 14px;
      color: #2f241c;
    }
    .modal-title{ margin: 0 0 6px; font-size: 18px; }
    .modal-body{ margin: 0 0 10px; line-height: 1.5; }
    .modal-actions{ display: flex; justify-content: flex-end; gap: 8px; margin-top: 10px; }
    .modal-details-toggle{ background: none; border: none; color: var(--accent-strong); font-weight: 700; cursor: pointer; padding: 6px 0; }
    .modal-details{ display: none; background: #f9f6f1; border: 1px solid #e8ddcf; border-radius: 12px; padding: 10px; margin-top: 6px; white-space: pre-wrap; font-family: "SFMono-Regular",Consolas,"Liberation Mono",Menlo,monospace; font-size: 12px; color: #3c2c21; }
    .notice{
      margin: 6px 0 0;
      padding: 6px 8px;
      border-radius: 10px;
      background: #f7f4ee;
      border: 1px solid #e6dbcd;
      color: #594a36;
      font-size: 12px;
      font-weight: 500;
      display: flex;
      gap: 8px;
      align-items: flex-start;
    }
    .notice .info-icon{ flex: 0 0 auto; line-height: 1.2; }
    .notice .info-main{ font-weight: 600; color: #4a3c2c; }
    .notice .info-sub{ color: var(--muted2); font-size: 11px; margin-top: 2px; }
    .filter-calltypes.disabled{ opacity: 0.5; pointer-events: none; }
    .filter-calltypes.disabled .textinput{ cursor: not-allowed; }
    .filter-calltypes.generating .textinput{
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .filter-calltypes.generating .textinput::after{
      content: "";
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: 2px solid #cbd5e1;
      border-top-color: #64748b;
      animation: spin 0.9s linear infinite;
    }
    @media (max-width: 520px){
      .modal-card{ padding: 16px; border-radius: 16px; }
      .modal-title{ font-size: 16px; }
      .progressline{ font-size: 14px; }
    }
    @media (max-width: 760px){
      .wrap{ padding: 0 16px; }
      .filters{ grid-template-columns: 1fr; }
      .stepper{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (min-width: 900px){
      .filters{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .filter-calltypes{ order: 1; }
      .filter-budget{ order: 2; }
      .filter-opening{ order: 3; }
      .filter-deadline{ order: 4; }
    }
    @media (max-width: 520px){
      .stepper{ display:flex; flex-direction: column; }
      .dropzone{ padding: 14px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="topbar-header">
        <div class="brand">
          <h1>Horizon & EDF Call Extractor</h1>
          <p>Upload Horizon or EDF PDFs → get a table preview → download Excel when you click.</p>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="tabs">
        <button class="tab active" data-tab="horizon" id="tab-horizon">Horizon</button>
        <button class="tab" data-tab="edf" id="tab-edf">EDF</button>
      </div>
      <p class="hint">We automatically detect whether the PDF is Horizon or EDF to avoid mixing documents.</p>

      <div class="filters" id="filters">
        <div class="filter-item filter-calltypes" id="callTypesFilter">
          <div class="filterlabel">Call types</div>
          <div class="textinput clickable" id="typeSummary">All types</div>
          <div class="hint">Multi-select call types. Same UI for Horizon and EDF.</div>
          <div class="dropdown" id="typeMenu" style="margin-top:6px; display:none;">
            <div class="actions" style="margin-bottom:6px;">
              <button class="btn" type="button" id="typeAll">Select all</button>
              <button class="btn" type="button" id="typeNone">Select none</button>
            </div>
            <div id="typeList"></div>
          </div>
        </div>
        <div class="filter-item filter-budget">
          <div class="filterlabel">Min. budget per project (M€)</div>
          <div class="sliderwrap">
            <div class="bubble" id="budgetBubble">0 M€</div>
            <input type="range" id="budget" min="0" max="15" step="1" value="0" aria-label="Minimum budget per project in million euros"/>
            <div class="hint">Range 0 → 15+. At 15 it selects only ≥ 15 M€.</div>
          </div>
        </div>
        <div class="filter-item filter-opening">
          <div class="filterlabel">Opening date</div>
          <div class="date-row">
            <input class="textinput" id="openFilter" type="date" aria-label="Opening date filter" placeholder="YYYY-MM-DD"/>
            <button class="btn clear-btn" type="button" id="openClear">Clear</button>
          </div>
          <div class="hint">Pick a date (YYYY-MM-DD).</div>
        </div>
        <div class="filter-item filter-deadline">
          <div class="filterlabel">Deadline date</div>
          <div class="date-row">
            <input class="textinput" id="deadlineFilter" type="date" aria-label="Deadline date filter" placeholder="YYYY-MM-DD"/>
            <button class="btn clear-btn" type="button" id="deadlineClear">Clear</button>
          </div>
          <div class="hint">Pick a date (YYYY-MM-DD).</div>
        </div>
      </div>

      <div class="dropzone" id="dz">
        <input id="fileInput" type="file" accept="application/pdf" multiple />
        <div class="dzrow">
          <div class="filemeta">
            <div class="filename" id="filename">No files selected</div>
            <div class="filesub" id="filesub">Horizon: upload 1–6 PDFs. EDF: single PDF.</div>
            <ul class="filelist" id="filelist"></ul>
          </div>
          <div class="actions">
            <button class="btn" id="clear" disabled>Remove</button>
            <button class="btn" id="cancel" style="display:none;">Cancel</button>
            <button class="btn primary" id="go" disabled>Generate Excel</button>
          </div>
        </div>
        <div class="progresswrap">
          <div class="progressline">
            <span class="progressstage" id="progressLabel">Idle</span>
            <span class="progressvalue" id="progressText">0%</span>
          </div>
          <div class="progress" aria-label="progress">
            <div class="bar" id="bar"></div>
          </div>
        </div>
        <div class="stepper" aria-label="steps">
          <div class="step" id="s1"><span class="badge">1</span><span>Presign URL</span></div>
          <div class="step" id="s2"><span class="badge">2</span><span>Upload PDFs</span></div>
          <div class="step" id="s3"><span class="badge">3</span><span>Parse + Excel</span></div>
          <div class="step" id="s4"><span class="badge">4</span><span>Download link</span></div>
        </div>
        <div class="statusbox">
          <div class="statusline" id="status">
            <div>
              <div class="ok" id="statusMain">Select PDF(s) to get started.</div>
              <div class="hint" id="statusSub">Drag & drop or tap to choose. No auto-downloads on mobile.</div>
            </div>
          </div>
          <div class="kpi" id="kpi" style="display:none;">
            <div class="chip">Rows: <strong id="rows">0</strong></div>
            <div class="chip">Status: <strong id="final">Ready</strong></div>
            <button class="btn primary" id="downloadBtn" style="display:none;">Download Excel</button>
          </div>
        </div>
      </div>
    </div>

    <div class="card results active" id="results-horizon">
      <h3>Horizon table</h3>
      <p class="hint">Preview columns: Topic ID (clickable), Min Budget per Project (M€), Opening Date, Deadline Date. Funding percentage is shown next to the call type.</p>
      <div class="notice" id="aiNotice-horizon" style="display:none;">
        <span class="info-icon">ℹ️</span>
        <div class="info-text">
          <div class="info-main"></div>
          <div class="info-sub"></div>
        </div>
      </div>
      <div class="table" id="table-horizon"></div>
    </div>

    <div class="card results" id="results-edf">
      <h3>EDF table</h3>
      <p class="hint">Same UI and columns as Horizon. Topic IDs link to Funding &amp; Tenders. Funding % is displayed only when explicitly stated in the PDF.</p>
      <div class="notice" id="aiNotice-edf" style="display:none;">
        <span class="info-icon">ℹ️</span>
        <div class="info-text">
          <div class="info-main"></div>
          <div class="info-sub"></div>
        </div>
      </div>
      <div class="table" id="table-edf"></div>
    </div>
  </div>

  <div class="modal-overlay" id="errorModal" role="dialog" aria-modal="true" aria-labelledby="errorTitle" aria-describedby="errorBody">
    <div class="modal-card">
      <h3 class="modal-title" id="errorTitle">Something went wrong</h3>
      <p class="modal-body" id="errorBody">We couldn’t process the file. Please try again.</p>
      <button class="modal-details-toggle" id="errorDetailsToggle" type="button" aria-expanded="false" aria-controls="errorDetails" style="display:none;">Show details</button>
      <div class="modal-details" id="errorDetails"></div>
      <div class="modal-actions">
        <button class="btn" type="button" id="errorClose">Close</button>
      </div>
    </div>
  </div>

  <script>
    window.APP_VERSION = "__APP_VERSION__";
    const $ = (id) => document.getElementById(id);
    const CALL_TYPE_LABELS = {
      "RIA": "RIA (Research and Innovation Actions)",
      "IA": "IA (Innovation Actions)",
      "CSA": "CSA (Coordination and Support Actions)",
      "PCP": "PCP (Pre-Commercial Procurement)",
      "PPI": "PPI (Public Procurement of Innovative Solutions)",
      "COFUND": "COFUND (Co-fund Actions)",
      "ERC": "ERC (European Research Council)",
      "MSCA": "MSCA (Marie Skłodowska-Curie Actions)",
      "EIC-PATHFINDER": "EIC-PATHFINDER (EIC Pathfinder)",
      "EIC-TRANSITION": "EIC-TRANSITION (EIC Transition)",
      "EIC-ACCELERATOR": "EIC-ACCELERATOR (EIC Accelerator)",
      "RA": "RA (Research Actions)",
      "DA": "DA (Development Actions)",
    };
    const HORIZON_CALL_TYPES = [
      { name: "RIA", label: CALL_TYPE_LABELS["RIA"] },
      { name: "IA", label: CALL_TYPE_LABELS["IA"] },
      { name: "CSA", label: CALL_TYPE_LABELS["CSA"] },
      { name: "PCP", label: CALL_TYPE_LABELS["PCP"] },
      { name: "PPI", label: CALL_TYPE_LABELS["PPI"] },
      { name: "COFUND", label: CALL_TYPE_LABELS["COFUND"] },
      { name: "ERC", label: CALL_TYPE_LABELS["ERC"] },
      { name: "MSCA", label: CALL_TYPE_LABELS["MSCA"] },
      { name: "EIC-PATHFINDER", label: CALL_TYPE_LABELS["EIC-PATHFINDER"] },
      { name: "EIC-TRANSITION", label: CALL_TYPE_LABELS["EIC-TRANSITION"] },
      { name: "EIC-ACCELERATOR", label: CALL_TYPE_LABELS["EIC-ACCELERATOR"] },
    ];
    const EDF_CALL_TYPES = [
      { name: "RA", label: "RA (Research Actions)" },
      { name: "DA", label: "DA (Development Actions)" },
      { name: "CSA", label: "CSA (Coordination & Support Actions)" },
    ];
    const state = {
      activeTab: "horizon",
      tabs: {
        horizon: { files: [], callTypes: [...HORIZON_CALL_TYPES], selectedTypes: new Set(HORIZON_CALL_TYPES.map(t => t.name)), minBudget: 0, openingFilter: "", deadlineFilter: "" },
        edf: { files: [], callTypes: [...EDF_CALL_TYPES], selectedTypes: new Set(EDF_CALL_TYPES.map(t => t.name)), minBudget: 0, openingFilter: "", deadlineFilter: "" },
      },
      results: {
        horizon: { rows: [], downloadUrl: null, rowsCount: 0, summaryNotice: "" },
        edf: { rows: [], downloadUrl: null, rowsCount: 0, summaryNotice: "" },
      },
      busy: false,
      exporting: false,
      currentRunId: null,
      abort: null,
      uploadXhrs: [],
      processTicker: null,
      progressPct: 0,
    };

    function fmtBytes(bytes){
      const u = ["B","KB","MB","GB"];
      let i = 0; let n = bytes;
      while(n >= 1024 && i < u.length-1){ n/=1024; i++; }
      return (i === 0 ? n : n.toFixed(1)) + " " + u[i];
    }

    function newRunId(){
      if(window.crypto && crypto.randomUUID){
        return crypto.randomUUID();
      }
      return `run-${Date.now()}-${Math.random().toString(16).slice(2)}`;
    }

    function startRun(){
      const id = newRunId();
      state.currentRunId = id;
      return id;
    }

    function clearRun(id){
      if(state.currentRunId === id){
        state.currentRunId = null;
      }
    }

    function ensureActiveRun(id){
      if(!id || state.currentRunId !== id){
        throw new DOMException("Stale run", "AbortError");
      }
    }

    const budgetFormatter = new Intl.NumberFormat("en-US", { minimumFractionDigits: 0, maximumFractionDigits: 2 });
    function formatBudget(val){
      const num = Number(val);
      if(Number.isNaN(num)) return "—";
      const digits = Number.isInteger(num) ? 0 : (Math.abs(num) < 10 ? 2 : 1);
      const formatted = num.toLocaleString("en-US", { minimumFractionDigits: 0, maximumFractionDigits: digits });
      return `${formatted} M€`;
    }

    function formatCallTypeLabel(opt){
      return opt.label || opt.name;
    }

    function normalizeTopicText(input){
      if(!input){
        return "";
      }
      let normalized = String(input)
        .replace(/\r\n/g, "\n")
        .replace(/\r/g, "\n")
        .replace(/[\u00ad\uFFFD]/g, "")
        .replace(/[\u2010\u2011\u2212]/g, "-")
        .replace(/&quot;/g, "\"")
        .replace(/&apos;/g, "'")
        .replace(/&#39;/g, "'")
        .replace(/[ \t]+$/gm, "");
      let prev = null;
      while(prev !== normalized){
        prev = normalized;
        normalized = normalized.replace(/([\p{L}])\s*-\s*([\p{L}])/gu, "$1-$2");
      }
      normalized = normalized.replace(/([\p{L}])-\n([\p{L}])/gu, "$1-$2");
      return normalized.trim();
    }

    function fixLeadingCapitalization(title){
      const trimmed = String(title || "").trimStart();
      if(!trimmed){
        return "";
      }
      const firstChar = trimmed[0];
      if(!/[A-Za-z]/.test(firstChar)){
        return trimmed;
      }
      if(firstChar === firstChar.toUpperCase()){
        return trimmed;
      }
      return firstChar.toUpperCase() + trimmed.slice(1);
    }

    function parseTopicDescription(text){
      const full = normalizeTopicText(text);
      if(!full){
        return { full: "", preview: "", expected: "", scope: "" };
      }
      const scopeMatch = full.match(/(?:^|\n)Scope:\s*/i);
      let expected = full;
      let scope = "";
      if(scopeMatch){
        expected = full.slice(0, scopeMatch.index).trim();
        scope = full.slice(scopeMatch.index + scopeMatch[0].length).trim();
      }
      expected = expected.replace(/^Expected Outcome:?\s*/i, "").trim();
      const previewSource = (expected || full).trim();
      const basePreview = previewSource
        .split("\n")
        .map(line => line.replace(/\s+/g, " ").trim())
        .join("\n")
        .trim();
      const maxPreview = 240;
      let previewText = basePreview;
      if(previewText.length > maxPreview){
        previewText = previewText.slice(0, maxPreview).replace(/\s+\S*$/, "").trim() + "…";
      }
      const preview = expected ? `Expected Outcome: ${previewText}` : previewText;
      return { full, preview, expected, scope };
    }

    function escapeHtml(text){
      return String(text)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function renderSupSafe(text){
      const escaped = escapeHtml(text || "");
      return escaped.replace(/&lt;sup&gt;(\d{1,3})&lt;\/sup&gt;/g, "<sup>$1</sup>");
    }

    const bracketRefRegex = /\[(\d{1,4})\]/g;
    const attachedRefRegex = /([A-Za-z\)])(\d{1,2})(?=[^0-9A-Za-z]|$)/g;
    const urlRegex = /https?:\/\/\S+/gi;
    const referenceLineRegex = /^\s*(?:\[(\d{1,4})\]|(\d{1,4}))\s+(.+?)\s*(https?:\/\/\S+)\s*$/i;
    const referenceUrlOnlyRegex = /^\s*(https?:\/\/\S+)\s*$/i;
    const labelOnlyRegex = /^(Expected Outcome|Scope):?\s*$/i;
    const labelInlineRegex = /^(Expected Outcome|Scope)\s*:/i;

    function cleanUrl(url){
      return url.replace(/[),.;:]+$/g, "");
    }

    function ensureReferenceEntry(rawId, data, map){
      const existing = map.get(rawId);
      if(!existing){
        map.set(rawId, data);
        return;
      }
      map.set(rawId, {
        url: existing.url || data.url,
        text: existing.text || data.text,
      });
    }

    function extractReferenceLine(line){
      const trimmed = line.trim();
      if(!trimmed){
        return null;
      }
      const match = trimmed.match(referenceLineRegex);
      if(match){
        const rawId = match[1] || match[2];
        const url = cleanUrl(match[4]);
        return { rawId, url, text: (match[3] || "").trim() || undefined };
      }
      const urlOnly = trimmed.match(referenceUrlOnlyRegex);
      if(urlOnly){
        const url = cleanUrl(urlOnly[1]);
        return { rawId: url, url };
      }
      return null;
    }

    function isSentenceContinuation(prev, next){
      if(/[.!?;:]$/.test(prev)){
        return false;
      }
      if(/^[a-z]/.test(next)){
        return true;
      }
      return /^[("“‘’\[]/.test(next);
    }

    function mergeLines(lines){
      const merged = [];
      for(let i = 0; i < lines.length; i += 1){
        const raw = lines[i].replace(/[ \t]+$/g, "");
        if(!raw.trim()){
          merged.push("");
          continue;
        }
        let current = raw.trim();
        while(i + 1 < lines.length){
          const next = lines[i + 1];
          const nextTrim = next.trim();
          if(!nextTrim){
            break;
          }
          if(/-$/.test(current) && /^[\p{L}]/u.test(nextTrim)){
            current = current.replace(/-$/, "-") + nextTrim;
            i += 1;
            continue;
          }
          if(labelOnlyRegex.test(current)){
            const labelText = current.replace(/:\s*$/, ":");
            current = `${labelText} ${nextTrim}`;
            i += 1;
            continue;
          }
          if(isSentenceContinuation(current, nextTrim)){
            current = `${current} ${nextTrim}`;
            i += 1;
            continue;
          }
          break;
        }
        merged.push(current);
      }
      return merged;
    }

    function getFootnoteIndex(rawId, state){
      if(state.map.has(rawId)){
        return state.map.get(rawId);
      }
      const nextIndex = state.order.length + 1;
      state.map.set(rawId, nextIndex);
      state.order.push(rawId);
      return nextIndex;
    }

    function tokenizeText(text, state, referenceMap){
      const tokens = [];
      let index = 0;
      while(index < text.length){
        urlRegex.lastIndex = index;
        bracketRefRegex.lastIndex = index;
        attachedRefRegex.lastIndex = index;
        const urlMatch = urlRegex.exec(text);
        const bracketMatch = bracketRefRegex.exec(text);
        const attachedMatch = attachedRefRegex.exec(text);
        const candidates = [urlMatch, bracketMatch, attachedMatch].filter(Boolean);
        if(!candidates.length){
          const remaining = text.slice(index);
          if(remaining){
            tokens.push({ kind: "text", text: remaining });
          }
          break;
        }
        let nextMatch = candidates[0];
        candidates.forEach((candidate) => {
          if(candidate.index < nextMatch.index){
            nextMatch = candidate;
          }
        });
        if(nextMatch.index > index){
          tokens.push({ kind: "text", text: text.slice(index, nextMatch.index) });
        }
        if(nextMatch === urlMatch){
          let url = nextMatch[0];
          let trailing = "";
          while(/[),.;:]+$/.test(url)){
            trailing = url.slice(-1) + trailing;
            url = url.slice(0, -1);
          }
          const clean = cleanUrl(url);
          ensureReferenceEntry(clean, { url: clean }, referenceMap);
          tokens.push({ kind: "footnoteRef", index: getFootnoteIndex(clean, state) });
          if(trailing){
            tokens.push({ kind: "text", text: trailing });
          }
          index = nextMatch.index + nextMatch[0].length;
          continue;
        }
        if(nextMatch === bracketMatch){
          const rawId = nextMatch[1];
          tokens.push({ kind: "footnoteRef", index: getFootnoteIndex(rawId, state) });
          index = nextMatch.index + nextMatch[0].length;
          continue;
        }
        const rawId = nextMatch[2];
        const prefixEnd = nextMatch.index + 1;
        const leadingText = text.slice(index, prefixEnd);
        if(leadingText){
          tokens.push({ kind: "text", text: leadingText });
        }
        tokens.push({ kind: "footnoteRef", index: getFootnoteIndex(rawId, state) });
        index = prefixEnd + rawId.length;
      }
      return tokens;
    }

    function tokenizeInline(text, state, referenceMap){
      const labelMatch = text.match(labelInlineRegex);
      if(labelMatch){
        const labelText = text.slice(0, labelMatch[0].length).trim();
        const tokens = [{ kind: "label", text: labelText }];
        const remainder = text.slice(labelMatch[0].length).trimStart();
        if(remainder){
          tokens.push(...tokenizeText(` ${remainder}`, state, referenceMap));
        }
        return tokens;
      }
      return tokenizeText(text, state, referenceMap);
    }

    function parseTopicDescriptionToBlocks(input){
      const normalized = normalizeTopicText(input);
      if(!normalized){
        return [];
      }
      const lines = mergeLines(normalized.split("\n"));
      const referenceMap = new Map();
      const workingLines = [];
      lines.forEach((line) => {
        const trimmed = line.trim();
        if(!trimmed){
          workingLines.push(line);
          return;
        }
        const reference = extractReferenceLine(trimmed);
        if(reference){
          ensureReferenceEntry(reference.rawId, { url: reference.url, text: reference.text }, referenceMap);
          return;
        }
        workingLines.push(line);
      });
      const blocks = [];
      let paragraph = [];
      let listItems = [];
      const footnoteState = { map: new Map(), order: [] };
      const flushParagraph = () => {
        if(paragraph.length){
          const text = paragraph.join(" ").replace(/\s+/g, " ").trim();
          if(text){ blocks.push({ kind: "paragraph", tokens: tokenizeInline(text, footnoteState, referenceMap) }); }
          paragraph = [];
        }
      };
      const flushList = () => {
        if(listItems.length){
          blocks.push({ kind: "list", items: listItems });
          listItems = [];
        }
      };
      workingLines.forEach((line) => {
        const trimmed = line.trim();
        if(!trimmed){
          flushParagraph();
          flushList();
          return;
        }
        const bulletMatch = trimmed.match(/^([•\-–])\s+(.*)$/);
        if(bulletMatch){
          flushParagraph();
          listItems.push(tokenizeInline(bulletMatch[2].trim(), footnoteState, referenceMap));
          return;
        }
        flushList();
        paragraph.push(trimmed);
      });
      flushParagraph();
      flushList();
      if(footnoteState.order.length){
        const items = footnoteState.order.map((rawId, index) => ({
          index: index + 1,
          rawId,
          url: (referenceMap.get(rawId) || {}).url,
          text: (referenceMap.get(rawId) || {}).text,
        }));
        blocks.push({ kind: "references", items });
      }
      return blocks;
    }

    function appendLinkifiedText(parent, text){
      parent.appendChild(document.createTextNode(text));
    }

    function appendInlineTokens(parent, tokens){
      tokens.forEach((token) => {
        if(token.kind === "text"){
          appendLinkifiedText(parent, token.text);
          return;
        }
        if(token.kind === "label"){
          const strong = document.createElement("strong");
          strong.textContent = token.text;
          parent.appendChild(strong);
          return;
        }
        const sup = document.createElement("sup");
        sup.className = "desc-footnote";
        const link = document.createElement("a");
        link.href = `#reference-${token.index}`;
        link.textContent = `[${token.index}]`;
        sup.appendChild(link);
        parent.appendChild(sup);
      });
    }

    function getReferenceLabel(url){
      if(!url){
        return "";
      }
      return url.replace(/^https?:\/\//, "").split(/[/?#]/)[0];
    }

    function renderTopicDescriptionBlocks(text, container){
      container.textContent = "";
      const blocks = parseTopicDescriptionToBlocks(text);
      blocks.forEach((block) => {
        if(block.kind === "heading"){
          const h = document.createElement("h4");
          h.textContent = block.text;
          container.appendChild(h);
          return;
        }
        if(block.kind === "paragraph"){
          const p = document.createElement("p");
          appendInlineTokens(p, block.tokens);
          container.appendChild(p);
          return;
        }
        if(block.kind === "list"){
          const ul = document.createElement("ul");
          block.items.forEach((item) => {
            const li = document.createElement("li");
            appendInlineTokens(li, item);
            ul.appendChild(li);
          });
          container.appendChild(ul);
          return;
        }
        if(block.kind === "separator"){
          const sep = document.createElement("div");
          sep.className = "desc-separator";
          container.appendChild(sep);
        }
        if(block.kind === "references"){
          const wrap = document.createElement("div");
          wrap.className = "desc-references";
          const title = document.createElement("div");
          title.className = "desc-references-title";
          title.textContent = "References";
          const list = document.createElement("ul");
          list.className = "desc-references-list";
          block.items.forEach((item) => {
            const li = document.createElement("li");
            li.className = "desc-reference-item";
            li.id = `reference-${item.index}`;
            const num = document.createElement("span");
            num.className = "desc-reference-num";
            num.textContent = `[${item.index}]`;
            li.appendChild(num);
            const content = document.createElement("span");
            content.className = "desc-reference-content";
            const label = item.text || (item.url ? getReferenceLabel(item.url) : "");
            if(label){
              const labelSpan = document.createElement("span");
              labelSpan.textContent = label;
              content.appendChild(labelSpan);
            }
            if(item.url){
              if(label){
                const dash = document.createElement("span");
                dash.textContent = "—";
                dash.setAttribute("aria-hidden", "true");
                content.appendChild(dash);
              }
              const link = document.createElement("a");
              link.href = item.url;
              link.target = "_blank";
              link.rel = "noreferrer";
              link.className = "desc-link";
              link.textContent = item.url;
              content.appendChild(link);
            } else if(!label){
              content.appendChild(document.createTextNode("Reference unavailable"));
            }
            li.appendChild(content);
            list.appendChild(li);
          });
          wrap.appendChild(title);
          wrap.appendChild(list);
          container.appendChild(wrap);
        }
      });
    }

    function updateTypeSummary(tab = state.activeTab){
      if(state.exporting){
        $("typeSummary").textContent = "Generating…";
        return;
      }
      const sel = state.tabs[tab].selectedTypes;
      const opts = state.tabs[tab].callTypes;
      const size = sel.size;
      let summary = "No types";
      if(size === opts.length && opts.length){ summary = "All types"; }
      else if(size === 1){
        const first = opts.find(o => sel.has(o.name));
        summary = first ? formatCallTypeLabel(first) : "No types";
      } else if(size > 1){
        const first = opts.find(o => sel.has(o.name));
        summary = first ? `${formatCallTypeLabel(first)} +${size-1}` : "No types";
      }
      $("typeSummary").textContent = summary;
    }

    function renderTypeList(tab = state.activeTab){
      const box = $("typeList");
      box.innerHTML = "";
      const opts = state.tabs[tab].callTypes;
      if(!opts.length){
        box.textContent = "No call types available.";
        updateTypeSummary(tab);
        return;
      }
      opts.forEach(opt => {
        const lbl = document.createElement("label");
        lbl.style.display = "inline-flex";
        lbl.style.alignItems = "center";
        lbl.style.gap = "8px";
        lbl.style.marginRight = "10px";
        lbl.style.marginBottom = "6px";
        lbl.style.fontSize = "13px";
        lbl.style.fontWeight = "400";
        const input = document.createElement("input");
        input.type = "checkbox"; input.value = opt.name; input.checked = state.tabs[tab].selectedTypes.has(opt.name);
        input.disabled = state.busy || state.exporting;
        input.onchange = () => {
          if(input.checked) state.tabs[tab].selectedTypes.add(opt.name); else state.tabs[tab].selectedTypes.delete(opt.name);
          updateTypeSummary(tab);
        };
        const span = document.createElement("span"); span.textContent = formatCallTypeLabel(opt);
        lbl.appendChild(input); lbl.appendChild(span); box.appendChild(lbl);
      });
      updateTypeSummary(tab);
    }

    function setBudget(val, tab = state.activeTab){
      const num = Math.min(15, Math.max(0, Math.round(Number(val) || 0)));
      state.tabs[tab].minBudget = num;
      $("budget").value = String(num);
      $("budgetBubble").textContent = num >= 15 ? "15+ M€" : `${num} M€`;
    }

    function updateDateClearButtons(tab = state.activeTab){
      const openVal = state.tabs[tab].openingFilter || "";
      const deadlineVal = state.tabs[tab].deadlineFilter || "";
      $("openClear").disabled = state.busy || !openVal;
      $("deadlineClear").disabled = state.busy || !deadlineVal;
    }

    function setCallTypeDisabled(disabled){
      const filter = $("callTypesFilter");
      filter.classList.toggle("disabled", disabled);
      $("typeSummary").setAttribute("aria-disabled", disabled ? "true" : "false");
      $("typeSummary").tabIndex = disabled ? -1 : 0;
      $("typeAll").disabled = disabled;
      $("typeNone").disabled = disabled;
      $("typeList").querySelectorAll("input[type=checkbox]").forEach((input) => {
        input.disabled = disabled;
      });
      if(disabled){
        $("typeMenu").style.display = "none";
      }
    }

    function syncDateInputs(tab = state.activeTab){
      $("openFilter").value = state.tabs[tab].openingFilter || "";
      $("deadlineFilter").value = state.tabs[tab].deadlineFilter || "";
      updateDateClearButtons(tab);
    }

    function setStatus(main, sub, isError=false){
      $("statusMain").textContent = main;
      $("statusSub").textContent = sub || "";
      $("final").textContent = isError ? "ERROR" : "Ready";
      $("final").style.color = isError ? "var(--bad)" : "var(--text)";
    }

    function hideErrorModal(){
      const modal = $("errorModal");
      const details = $("errorDetails");
      const toggle = $("errorDetailsToggle");
      modal.style.display = "none";
      details.style.display = "none";
      toggle.textContent = "Show details";
      toggle.setAttribute("aria-expanded", "false");
    }

    function showErrorModal(userMessage, technicalMessage="", title="Something went wrong"){
      $("errorTitle").textContent = title || "Something went wrong";
      $("errorBody").textContent = userMessage || "We couldn’t process the file. Please try again.";
      const details = $("errorDetails");
      const toggle = $("errorDetailsToggle");
      if(technicalMessage){
        details.textContent = technicalMessage;
        details.style.display = "none";
        toggle.style.display = "inline-flex";
        toggle.textContent = "Show details";
        toggle.setAttribute("aria-expanded", "false");
      } else {
        details.textContent = "";
        details.style.display = "none";
        toggle.style.display = "none";
      }
      $("errorModal").style.display = "flex";
    }

    function setProgressStage(text){
      $("progressLabel").textContent = text || "Progress";
    }

    function _updateBarWidth(){
      const bar = $("bar");
      if(bar.classList.contains("indet")){
        bar.style.width = "100%";
      } else {
        bar.style.width = `${state.progressPct}%`;
      }
    }
    function setProgress(pct){
      const val = Math.max(0, Math.min(100, Number(pct) || 0));
      state.progressPct = val;
      $("progressText").textContent = `${Math.round(val)}%`;
      _updateBarWidth();
    }
    function barNone(){ $("bar").classList.remove("indet"); setProgressStage("Idle"); setProgress(0); }
    function barIndeterminate(){ $("bar").classList.add("indet"); _updateBarWidth(); }
    function barDeterminate(){ $("bar").classList.remove("indet"); _updateBarWidth(); }

    function setSteps(activeIdx, doneBefore=false){
      const steps = [$("s1"),$("s2"),$("s3"),$("s4")];
      steps.forEach((el, idx) => {
        el.classList.remove("active","done");
        if(doneBefore && idx < activeIdx) el.classList.add("done");
        if(idx === activeIdx) el.classList.add("active");
      });
    }
    function clearSteps(){ [$("s1"),$("s2"),$("s3"),$("s4")].forEach(el => el.classList.remove("active","done")); }

    function stopProcessDrift(){
      if(state.processTicker){
        clearInterval(state.processTicker);
        state.processTicker = null;
      }
    }
    function startProcessDrift(start=60, end=85){
      stopProcessDrift();
      barIndeterminate();
      if(state.progressPct < start){
        setProgress(start);
      }
      state.processTicker = setInterval(() => {
        if(state.progressPct < end){
          setProgress(state.progressPct + 1);
        } else {
          stopProcessDrift();
        }
      }, 1200);
    }

    function setBusy(busy){
      state.busy = busy;
      $("go").disabled = busy || !(state.tabs[state.activeTab].files.length);
      $("clear").disabled = busy || !(state.tabs[state.activeTab].files.length);
      $("cancel").style.display = busy ? "inline-flex" : "none";
      $("cancel").disabled = !busy;
      $("fileInput").disabled = busy;
      $("budget").disabled = busy;
      $("openFilter").disabled = busy;
      $("deadlineFilter").disabled = busy;
      setCallTypeDisabled(busy || state.exporting);
      updateDateClearButtons(state.activeTab);
    }

    function setExporting(exporting){
      state.exporting = exporting;
      $("callTypesFilter").classList.toggle("generating", exporting);
      if(exporting){
        $("typeSummary").textContent = "Generating…";
      } else {
        updateTypeSummary(state.activeTab);
      }
      setCallTypeDisabled(state.busy || exporting);
    }

    function setFiles(tab, files){
      state.tabs[tab].files = files || [];
      state.results[tab] = { rows: [], downloadUrl: null, rowsCount: 0, summaryNotice: "" };
      $("downloadBtn").style.display = "none";
      $("kpi").style.display = "none";
      stopProcessDrift();
      state.uploadXhrs.forEach(x => { try{ x.abort(); }catch(_e){} });
      state.uploadXhrs = [];
      barNone();
      renderFileList();
      setBusy(false);
      if(files.length){
        setStatus("Ready to generate Excel.", `${files.length} PDF${files.length>1?"s":""} selected.`);
      } else {
        setStatus("Select PDF(s) to get started.", "Drag & drop or tap to choose.");
        clearSteps(); barNone();
      }
    }

    function renderFileList(){
      const files = state.tabs[state.activeTab].files;
      if(!files.length){
        $("filename").textContent = "No files selected";
        $("filesub").textContent = "Horizon: upload 1–6 PDFs. EDF: single PDF.";
        $("filelist").innerHTML = "";
        return;
      }
      $("filename").textContent = files.length === 1 ? (files[0].name || "file.pdf") : `${files.length} PDFs selected`;
      $("filesub").textContent = files.length === 1 ? `${fmtBytes(files[0].size)} • ${(files[0].type || "application/pdf")}` : "Multi-upload enabled (Horizon only).";
      $("filelist").innerHTML = files.map(f => `<li>${f.name || "file.pdf"}</li>`).join("");
    }

    function switchTab(tab){
      if(state.activeTab === tab) return;
      state.activeTab = tab;
      document.querySelectorAll(".tab").forEach(btn => btn.classList.toggle("active", btn.dataset.tab === tab));
      $("results-horizon").classList.toggle("active", tab === "horizon");
      $("results-edf").classList.toggle("active", tab === "edf");
      $("fileInput").multiple = tab === "horizon";
      syncDateInputs(tab);
      setBudget(state.tabs[tab].minBudget, tab);
      renderTypeList(tab);
      renderFileList();
      renderResults(tab);
      setBusy(state.busy);
    }

    function isPdfFile(f){
      const nameOk = (f.name || "").toLowerCase().endsWith(".pdf");
      const typeOk = (f.type || "") === "application/pdf";
      return nameOk || typeOk;
    }

    const dz = $("dz");
    dz.addEventListener("click", (e) => {
      if(e.target.closest("button")) return;
      $("fileInput").click();
    });
    ["dragenter","dragover"].forEach(evt => dz.addEventListener(evt, (e) => {
      e.preventDefault(); e.stopPropagation(); dz.classList.add("drag");
    }));
    ["dragleave","drop"].forEach(evt => dz.addEventListener(evt, (e) => {
      e.preventDefault(); e.stopPropagation(); dz.classList.remove("drag");
    }));
    dz.addEventListener("drop", (e) => {
      const files = Array.from(e.dataTransfer?.files || []).filter(isPdfFile);
      if(!files.length){
        setStatus("Invalid format.", "Select PDF files (.pdf).", true);
        return;
      }
      applyFileSelection(files);
    });

    function applyFileSelection(files){
      const tab = state.activeTab;
      if(tab === "horizon" && files.length > 6){
        setStatus("Too many files.", "Upload up to 6 Horizon PDFs at once.", true);
        return;
      }
      if(tab === "edf" && files.length !== 1){
        setStatus("EDF accepts one PDF per run.", "Please select a single EDF PDF.", true);
        return;
      }
      if(!files.every(isPdfFile)){
        setStatus("Invalid format.", "Select PDF files (.pdf).", true);
        return;
      }
      setFiles(tab, files);
    }

    $("fileInput").addEventListener("change", () => {
      const files = Array.from($("fileInput").files || []);
      if(!files.length) return;
      applyFileSelection(files);
      $("fileInput").value = "";
    });

    $("clear").onclick = () => { setFiles(state.activeTab, []); $("fileInput").value = ""; };

    $("typeSummary").onclick = () => {
      if(state.busy || state.exporting) return;
      const menu = $("typeMenu");
      const isOpen = menu.style.display === "block";
      if(isOpen){
        menu.style.display = "none";
        return;
      }
      renderTypeList(state.activeTab);
      menu.style.display = "block";
    };
    $("typeAll").onclick = () => {
      const tab = state.activeTab;
      const names = state.tabs[tab].callTypes.map(o => o.name);
      state.tabs[tab].selectedTypes = new Set(names);
      renderTypeList(tab);
    };
    $("typeNone").onclick = () => {
      const tab = state.activeTab;
      state.tabs[tab].selectedTypes = new Set();
      renderTypeList(tab);
    };
    $("errorDetailsToggle").onclick = () => {
      const details = $("errorDetails");
      const expanded = details.style.display === "block";
      details.style.display = expanded ? "none" : "block";
      $("errorDetailsToggle").textContent = expanded ? "Show details" : "Hide details";
      $("errorDetailsToggle").setAttribute("aria-expanded", expanded ? "false" : "true");
    };
    $("errorClose").onclick = hideErrorModal;
    $("errorModal").addEventListener("click", (e) => {
      if(e.target === $("errorModal")) hideErrorModal();
    });
    document.addEventListener("click", (e) => {
      if(e.target === $("typeSummary") || $("typeMenu").contains(e.target)) return;
      $("typeMenu").style.display = "none";
    });

    $("budget").addEventListener("input", (e) => setBudget(e.target.value, state.activeTab));
    $("openFilter").addEventListener("input", (e) => {
      state.tabs[state.activeTab].openingFilter = (e.target.value || "").trim();
      updateDateClearButtons();
    });
    $("deadlineFilter").addEventListener("input", (e) => {
      state.tabs[state.activeTab].deadlineFilter = (e.target.value || "").trim();
      updateDateClearButtons();
    });
    $("openClear").onclick = () => {
      state.tabs[state.activeTab].openingFilter = "";
      $("openFilter").value = "";
      updateDateClearButtons();
    };
    $("deadlineClear").onclick = () => {
      state.tabs[state.activeTab].deadlineFilter = "";
      $("deadlineFilter").value = "";
      updateDateClearButtons();
    };

    $("tab-horizon").onclick = () => switchTab("horizon");
    $("tab-edf").onclick = () => switchTab("edf");

    renderTypeList(state.activeTab);

    $("downloadBtn").onclick = () => {
      const dl = state.results[state.activeTab].downloadUrl;
      if(dl) window.location = dl;
    };

    function renderResults(tab){
      const res = state.results[tab];
      $("rows").textContent = String(res.rowsCount || res.rows.length || 0);
      $("kpi").style.display = res.rows.length ? "flex" : "none";
      const dlBtn = $("downloadBtn");
      dlBtn.style.display = res.downloadUrl ? "inline-flex" : "none";
      dlBtn.classList.toggle("success", Boolean(res.downloadUrl));
      const noticeEl = tab === "horizon" ? $("aiNotice-horizon") : $("aiNotice-edf");
      const noticeText = (res.summaryNotice || "").trim();
      if(noticeText){
        const [main, ...rest] = noticeText.split("\n");
        const mainEl = noticeEl.querySelector(".info-main");
        const subEl = noticeEl.querySelector(".info-sub");
        if(mainEl) mainEl.textContent = main.trim();
        const subText = rest.join("\n").trim();
        if(subEl){
          subEl.textContent = subText;
          subEl.style.display = subText ? "block" : "none";
        }
        noticeEl.style.display = "flex";
      } else {
        noticeEl.style.display = "none";
      }

      const box = tab === "horizon" ? $("table-horizon") : $("table-edf");
      box.innerHTML = "";
      res.rows.forEach((r) => {
        const card = document.createElement("div");
        card.className = "row-card";
        const id = document.createElement("div");
        id.className = "idline";
        if(r.topic_url){
          const a = document.createElement("a");
          a.href = r.topic_url;
          a.target = "_blank"; a.rel = "noreferrer";
          a.textContent = r.topic_id || "—";
          a.className = "link";
          id.appendChild(a);
        } else {
          const span = document.createElement("span");
          span.textContent = r.topic_id || "—";
          id.appendChild(span);
        }
        const callType = r.call_type || "—";
        const callPill = document.createElement("span");
        callPill.className = "pill callpill";
        callPill.textContent = callType;
        id.appendChild(callPill);
        const funding = (r.funding_percentage && String(r.funding_percentage).trim()) ? String(r.funding_percentage).trim() : "N/A";
        const fundPill = document.createElement("span");
        fundPill.className = "pill";
        fundPill.textContent = `Funding: ${funding}`;
        id.appendChild(fundPill);
        card.appendChild(id);

        const title = document.createElement("div");
          title.className = "subtitle"; title.textContent = fixLeadingCapitalization(r.topic_title || "—");
        card.appendChild(title);

        const descData = parseTopicDescription(r.topic_description || r.summary);
        if(descData.full){
          const summaryWrap = document.createElement("div");
          summaryWrap.className = "summary-block";
          const label = document.createElement("div");
          label.className = "label";
          label.textContent = "Topic description";

          const previewText = document.createElement("div");
          previewText.className = "summary-text desc-preview desc-content";
          renderTopicDescriptionBlocks(descData.preview, previewText);

          const fullText = document.createElement("div");
          fullText.className = "desc-body desc-content";
          renderTopicDescriptionBlocks(descData.full, fullText);
          fullText.style.display = "none";

          const toggle = document.createElement("button");
          toggle.type = "button";
          toggle.className = "summary-toggle";
          const needsToggle = descData.preview !== descData.full;
          toggle.textContent = needsToggle ? "Show more" : "";
          toggle.style.display = needsToggle ? "inline-flex" : "none";

          toggle.onclick = () => {
            const expanded = fullText.style.display === "none";
            fullText.style.display = expanded ? "block" : "none";
            previewText.style.display = expanded ? "none" : "block";
            toggle.textContent = expanded ? "Show less" : "Show more";
            toggle.setAttribute("aria-expanded", expanded ? "true" : "false");
            if(expanded){
              fullText.scrollIntoView({ behavior: "smooth", block: "nearest" });
            }
          };

          summaryWrap.appendChild(label);
          summaryWrap.appendChild(previewText);
          summaryWrap.appendChild(fullText);
          summaryWrap.appendChild(toggle);
          card.appendChild(summaryWrap);
        }

        const grid = document.createElement("div");
        grid.className = "row-grid";
        const fields = [
          ["Stage", r.stage || "—"],
          ["Call round", r.call_round || "—"],
          ["TRL", r.trl || "—"],
          ["Min. budget per project (M€)", formatBudget(r.budget_per_project_min_eur_m)],
          ["Opening date", r.opening_date || "—"],
          ["Deadline date", r.deadline_date || "—"],
        ];
        fields.forEach(([label, value]) => {
          const c = document.createElement("div");
          c.className = "cell";
          const l = document.createElement("span"); l.className = "label"; l.textContent = label;
          const v = document.createElement("span"); v.textContent = value ?? "—";
          c.appendChild(l); c.appendChild(v); grid.appendChild(c);
        });
        card.appendChild(grid);
        box.appendChild(card);
      });
    }

    function resetResult(tab){
      state.results[tab] = { rows: [], downloadUrl: null, rowsCount: 0, summaryNotice: "" };
      $("downloadBtn").style.display = "none";
      $("downloadBtn").classList.remove("success");
      $("kpi").style.display = "none";
      renderResults(tab);
    }

    async function fetchJson(url, opts){
      const res = await fetch(url, opts);
      const text = await res.text();
      let data = null;
      try{ data = text ? JSON.parse(text) : null; }catch(e){}
      if(!res.ok){
        const msg = (data && (data.message || data.error)) ? (data.message || data.error) : (text || ("HTTP " + res.status));
        const err = new Error(msg); err.status = res.status; err.payload = data; throw err;
      }
      return data;
    }

    function uploadWithProgress(files, uploads){
      return new Promise((resolve, reject) => {
        if(!files.length || !uploads.length){
          resolve(); return;
        }

        let settled = false;
        const finish = (fn) => { if(settled) return; settled = true; fn(); };

        const totalBytes = files.reduce((sum, f) => sum + (f.size || 0), 0);
        const perFileLoaded = new Map();
        const xhrs = [];
        state.uploadXhrs = xhrs;

        const updateProgress = () => {
          let uploaded = 0;
          perFileLoaded.forEach(v => { uploaded += v; });
          const base = 10;
          const range = 50;
          const pct = totalBytes
            ? base + (uploaded / totalBytes) * range
            : base + (perFileLoaded.size / uploads.length) * range;
          barDeterminate();
          setProgress(Math.min(60, pct));
        };

        uploads.forEach((up, idx) => {
          const xhr = new XMLHttpRequest();
          xhr.open("PUT", up.upload_url);
          xhr.upload.onprogress = (evt) => {
            if(evt.lengthComputable){
              perFileLoaded.set(idx, evt.loaded);
              updateProgress();
            }
          };
          xhr.onload = () => {
            perFileLoaded.set(idx, files[idx]?.size || perFileLoaded.get(idx) || 0);
            setStatus(`2/4 • Uploading ${perFileLoaded.size}/${uploads.length}`, files[idx]?.name || "");
            updateProgress();
            const ok = xhr.status >= 200 && xhr.status < 300;
            if(!ok){
              finish(() => reject(new Error("Upload failed: HTTP " + xhr.status)));
              return;
            }
            if(perFileLoaded.size === uploads.length){
              finish(() => {
                setProgress(60);
                resolve();
              });
            }
          };
          xhr.onerror = () => finish(() => reject(new Error("Upload failed: network error")));
          xhr.onabort = () => finish(() => reject(new DOMException("Upload aborted", "AbortError")));

          if(state.abort && state.abort.signal){
            state.abort.signal.addEventListener("abort", () => xhr.abort(), { once: true });
          }

          xhr.send(files[idx]);
          xhrs.push(xhr);
        });
      });
    }

    $("go").onclick = async () => {
      const tab = state.activeTab;
      const files = state.tabs[tab].files;
      if(!files.length){
        setStatus("Select PDF(s).", tab === "horizon" ? "Upload 1–6 Horizon PDFs." : "Upload one EDF PDF.", true);
        return;
      }
      const runId = startRun();
      state.abort = new AbortController();
      stopProcessDrift();
      state.uploadXhrs = [];
      setExporting(true);
      setBusy(true); resetResult(tab); barDeterminate(); setProgress(0); setProgressStage("Presigning");
      try{
        // Presign
        setSteps(0, false);
        setStatus("1/4 • Presign URL", "Requesting S3 upload links.");
        setProgress(5);
        const pres = await fetchJson(`/presign?count=${files.length}`, { signal: state.abort.signal });
        ensureActiveRun(runId);
        const uploads = pres.uploads || (pres.upload_url ? [{ upload_url: pres.upload_url, pdf_key: pres.pdf_key }] : []);
        if(uploads.length !== files.length){
          throw new Error("Presign count mismatch.");
        }

        // Upload
        setSteps(1, true);
        setProgressStage("Uploading");
        setProgress(10);
        setStatus(`2/4 • Uploading 1/${uploads.length}`, files[0].name || "");
        await uploadWithProgress(files, uploads);
        ensureActiveRun(runId);
        setStatus(`2/4 • Uploading ${uploads.length}/${uploads.length}`, "Uploads complete.");

        // Process
        setSteps(2, true);
        setProgressStage("Parsing + Excel");
        startProcessDrift(60, 85);
        setStatus("3/4 • Parsing + Excel…", "Detecting document family, applying filters, building workbook.");
        const payload = {
          pdf_keys: uploads.map(u => u.pdf_key),
          expected_type: tab,
          original_names: files.map(f => f.name || ""),
          call_types: Array.from(state.tabs[tab].selectedTypes),
          min_budget_m: state.tabs[tab].minBudget,
          opening_filter: state.tabs[tab].openingFilter,
          deadline_filter: state.tabs[tab].deadlineFilter,
        };

        const proc = await fetchJson("/process", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
          signal: state.abort.signal,
        });
        ensureActiveRun(runId);
        if(Array.isArray(proc.call_types)){
          const options = proc.call_types
            .filter(ct => ct?.name)
            .map(ct => ({ name: ct.name, label: CALL_TYPE_LABELS[ct.name] || ct.name }));
          const previous = new Set(state.tabs[tab].selectedTypes);
          state.tabs[tab].callTypes = options;
          const allowedNames = options.map(o => o.name);
          const kept = new Set([...previous].filter(n => allowedNames.includes(n)));
          if(previous.size === 0){
            state.tabs[tab].selectedTypes = new Set();
          } else if(kept.size){
            state.tabs[tab].selectedTypes = kept;
          } else {
            state.tabs[tab].selectedTypes = new Set(allowedNames);
          }
          renderTypeList(tab);
        }

        // Download link
        stopProcessDrift();
        barDeterminate();
        setProgressStage("Preparing download");
        setProgress(90);
        setSteps(3, true);
        setStatus("4/4 • Preparing download…", "Creating a temporary Excel link.");
        const dl = await fetchJson("/download", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ excel_key: proc.excel_key }),
          signal: state.abort.signal,
        });
        ensureActiveRun(runId);
        state.results[tab] = { rows: proc.rows || [], downloadUrl: dl.download_url, rowsCount: proc.rows_count || 0, summaryNotice: proc.summary_notice || "" };
        setProgress(100);
        setProgressStage("Done");
        [$("s1"),$("s2"),$("s3"),$("s4")].forEach(el => { el.classList.remove("active"); el.classList.add("done"); });
        renderResults(tab);
        setStatus("Completed ✅", "Download available on button click. No auto-downloads.");
        const container = tab === "horizon" ? $("results-horizon") : $("results-edf");
        container.scrollIntoView({ behavior: "smooth", block: "start" });
      }catch(e){
        stopProcessDrift();
        barNone(); clearSteps();
        setProgressStage("Error");
        const msg = e?.message || String(e);
        const detail = e?.status ? `HTTP ${e.status}. ` : "";
        const payload = e?.payload || {};
        if(e?.name === "AbortError"){
          setStatus("Cancelled.", "The operation was stopped on this device.");
          setBusy(false);
          state.abort = null;
          clearRun(runId);
          return;
        }
        const lowerMsg = msg.toLowerCase();
        let human = payload.message || "We couldn’t process the file. Please try again. If it keeps happening, try a different PDF or smaller file.";
        let title = "Something went wrong";
        if(payload.code === "WRONG_TAB"){
          const detectedRaw = payload.detected_type || payload.detected;
          const expectedRaw = payload.expected_type || tab;
          const detected = detectedRaw ? String(detectedRaw).toUpperCase() : "OTHER";
          const expected = expectedRaw ? String(expectedRaw).toUpperCase() : tab.toUpperCase();
          const filename = payload.filename ? ` (${payload.filename})` : "";
          title = "Wrong tab selected";
          human = `Wrong tab selected. This PDF looks like a ${detected} document${filename}. Switch to the ${expected} tab and try again.`;
        } else if(lowerMsg.includes("looks like edf")){
          title = "Wrong tab selected";
          human = "Wrong tab selected. This PDF looks like an EDF document. Switch to EDF tab and try again.";
        } else if(lowerMsg.includes("looks like horizon")){
          title = "Wrong tab selected";
          human = "Wrong tab selected. This PDF looks like a Horizon document. Switch to Horizon tab and try again.";
        }
        const technical = detail + (payload.details || payload.message || msg);
        showErrorModal(human, technical, title);
        setStatus("Error.", "Please check the message and try again.", true);
      }finally{
        clearRun(runId);
        setExporting(false);
        setBusy(false);
        state.abort = null;
        state.uploadXhrs = [];
        stopProcessDrift();
      }
    };

    $("cancel").onclick = () => {
      stopProcessDrift();
      if(state.abort){
        state.abort.abort();
      }
      state.uploadXhrs.forEach(x => { try{ x.abort(); }catch(_e){} });
      state.uploadXhrs = [];
      clearRun(state.currentRunId);
      clearSteps();
      barNone();
      resetResult(state.activeTab);
      setExporting(false);
      setBusy(false);
      setStatus("Cancelled.", "The operation was stopped on this device.");
    };

    function renderVersion(){
      const el = $("versionTag");
      const version = (window.APP_VERSION || "").trim();
      if(!version){
        el.style.display = "none";
        return;
      }
      el.textContent = `Deployed: ${version}`;
      el.style.display = "inline-flex";
    }

    // init
    renderVersion();
    renderTypeList();
    setBudget(state.tabs.horizon.minBudget);
    syncDateInputs();
    renderResults("horizon");
  </script>
</body>
</html>
